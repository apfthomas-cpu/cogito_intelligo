<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Pupil Dashboard ‚Äì Cogito, Intelligo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Friendly Font -->
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --teal: #8aaaaf;
      --teal-dark: #6d878c;
      --warm-yellow: #ffefad;
      --warm-yellow-dark: #f3dc85;
      --cream-bg: #fffdf4;
      --text-main: #2f3b3e;
      --text-muted: #6c7a86;
      --radius-lg: 1.2rem;
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.08);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Fredoka", sans-serif;
      font-size: 18px; /* Larger for pupils */
      background: var(--cream-bg);
      color: var(--text-main);
      min-height: 100vh;
    }

    /* HEADER -------------------------------------------------- */

    header {
      background: linear-gradient(135deg, var(--warm-yellow), var(--warm-yellow-dark));
      padding: 1.2rem 1rem;
      box-shadow: 0 4px 18px rgba(0,0,0,0.16);
    }

    .header-inner {
      max-width: 1100px;
      margin: auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .title {
      font-size: 1.8rem;
      font-weight: 500;
      color: var(--teal-dark);
    }

    .subtitle {
      font-size: 1rem;
      color: #4e595c;
    }

    .crest-mascot {
      width: 150px;
      height: auto;
      border-radius: 20px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
      background: var(--cream-bg);
    }

    .mission-banner {
      max-width: 1100px;
      margin: 1rem auto;
      padding: 1rem 1.4rem;
      background: linear-gradient(135deg, var(--teal), var(--teal-dark));
      color: white;
      border-radius: 999px;
      text-align: center;
      font-size: 1.1rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.18);
    }

    /* PAGE LAYOUT -------------------------------------------- */

    .page {
      max-width: 1100px;
      margin: 1.2rem auto 3rem;
      padding: 0 1rem;
    }

    .card {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 1.2rem 1.4rem;
      margin-bottom: 1.4rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }

    .card-title {
      font-size: 1.4rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-subtitle {
      font-size: 1rem;
      color: var(--text-muted);
    }

    .emoji { font-size: 1.4rem; }

    /* STATS --------------------------------------------------- */

    .stat-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 1rem;
      margin-top: 0.6rem;
    }

    @media (max-width: 750px) {
      .stat-row {
        grid-template-columns: repeat(2, minmax(0,1fr));
      }
    }

    .stat {
      padding: 0.8rem 1rem;
      background: #f7fbff;
      border-radius: 1rem;
      border: 1px solid #e2e8f0;
    }

    .stat-label {
      font-size: 1rem;
      color: var(--text-muted);
    }

    .stat-value {
      font-size: 1.4rem;
      font-weight: 500;
    }

    /* BADGES -------------------------------------------------- */

    .badge-row {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .badge-pill {
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      background: var(--warm-yellow);
      border: 1px solid #e8d98f;
      color: #6b5f23;
      font-size: 0.9rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* TABLE --------------------------------------------------- */

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1rem;
    }

    thead {
      background: var(--teal);
      color: white;
    }

    th, td {
      padding: 0.65rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e5e5e5;
    }

    tbody tr:nth-child(even) {
      background: #f9fbfd;
    }

    tbody tr:hover {
      background: #eef7ff;
    }

    /* ANSWERS ------------------------------------------------- */

    .answer-block {
      background: #f7f9fc;
      border-radius: 1rem;
      padding: 0.7rem 0.9rem;
      margin-bottom: 0.6rem;
      border: 1px solid #e2e6ee;
    }

    .answer-label {
      font-size: 1rem;
      color: var(--text-muted);
      margin-bottom: 0.3rem;
    }

    .answer-text {
      font-size: 1.05rem;
    }

    /* BUTTONS ------------------------------------------------- */

    .btn {
      display: inline-flex;
      align-items: center;
      padding: 0.6rem 1.1rem;
      border-radius: 999px;
      font-size: 1rem;
      border: none;
      cursor: pointer;
      color: white;
      background: var(--teal-dark);
      box-shadow: 0 4px 14px rgba(0,0,0,0.2);
    }

    .btn-outline {
      background: white;
      color: var(--teal-dark);
      border: 2px solid var(--teal-dark);
      box-shadow: none;
    }

    .btn-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    /* PRINT --------------------------------------------------- */

    @media print {
      header, .mission-banner, .btn-row {
        display: none !important;
      }
      body {
        background: white;
        font-size: 16px;
      }
      .card {
        box-shadow: none;
        border: 1px solid #ddd;
        page-break-inside: avoid;
      }
    }

  </style>
</head>

<body>

<header>
  <div class="header-inner">
    <div>
      <div class="title" id="headerName">Your Pupil Dashboard</div>
      <div class="subtitle" id="subtitleText"></div>
    </div>
    <img src="thinker_crest.png" class="crest-mascot" alt="School mascot">
  </div>
</header>

<div class="mission-banner">
  Aim for the higher gifts with <strong>joyfulness</strong> and <strong>kindness</strong>.
</div>

<div class="page">

  <!-- SUMMARY CARD --------------------------------------- -->

  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">
          <span class="emoji">üå±</span> <span id="welcomeTitle">Welcome</span>
        </div>
        <div class="card-subtitle">
          This dashboard shows your quiz attempts, scores, strengths, and what to work on next.
        </div>
      </div>
      <div class="pill" style="background:white; padding:0.4rem 0.9rem; border-radius:999px;">
        Live from your Cogito, Intelligo quizzes
      </div>
    </div>

    <div class="stat-row">
      <div class="stat">
        <div class="stat-label">Quizzes completed</div>
        <div class="stat-value" id="statAttempts">‚Äì</div>
      </div>
      <div class="stat">
        <div class="stat-label">Average total score</div>
        <div class="stat-value" id="statAvgTotal">‚Äì</div>
      </div>
      <div class="stat">
        <div class="stat-label">Strongest area</div>
        <div class="stat-value" id="statStrongest">‚Äì</div>
      </div>
      <div class="stat">
        <div class="stat-label">Focus area</div>
        <div class="stat-value" id="statWeakest">‚Äì</div>
      </div>
    </div>

    <!-- BADGES -->
    <div id="badgeRow" class="badge-row"></div>

    <!-- Strengths Summary -->
    <div id="strengthSummarySentence"
         style="margin-top:1rem; font-size:1.1rem; color:var(--teal-dark); font-weight:500;"></div>
  </section>

  <!-- CHARTS ------------------------------------------------ -->

  <section class="card" style="padding-bottom:2rem;">
    <div class="card-header">
      <div>
        <div class="card-title"><span class="emoji">üìà</span> Your scores over time</div>
        <div class="card-subtitle">
          Knowledge (3) ¬∑ Understanding (18) ¬∑ Evaluation & reasoning (8)
        </div>
      </div>
    </div>
    <canvas id="trendChart" height="230"></canvas>
  </section>

  <section class="card" style="padding-bottom:2rem;">
    <div class="card-header">
      <div>
        <div class="card-title"><span class="emoji">üìö</span> Topics you‚Äôve worked on</div>
        <div class="card-subtitle">Average scores by topic</div>
      </div>
    </div>
    <canvas id="topicChart" height="230"></canvas>
  </section>

  <!-- IMPROVEMENTS ----------------------------------------- -->

  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title"><span class="emoji">üí™</span> Things to keep working on</div>
        <div class="card-subtitle">
          Based on your Understanding and Evaluation feedback.
        </div>
      </div>
    </div>

    <!-- One-sentence improvement summary -->
    <div id="improvementSummarySentence"
         style="margin-bottom:1rem; font-size:1.1rem; color:var(--teal-dark); font-weight:500;"></div>

    <!-- Chips -->
    <div id="improvementChips"></div>
  </section>

  <!-- ATTEMPTS + ANSWERS ----------------------------------- -->

  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title"><span class="emoji">üîç</span> Your quiz attempts</div>
        <div class="card-subtitle">Click a quiz to see your answers.</div>
      </div>
      <div class="btn-row">
        <button class="btn-outline btn" onclick="window.print()">üñ® Print summary</button>
        <button class="btn-outline btn" onclick="window.history.back()">‚¨Ö Back</button>
      </div>
    </div>

    <div id="attemptHint" style="margin-bottom:0.75rem;"></div>

    <div style="max-height:260px; overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Quiz</th>
            <th>Total (29)</th>
            <th>Knowledge (3)</th>
            <th>Understanding (18)</th>
            <th>Evaluation & reasoning (8)</th>
          </tr>
        </thead>
        <tbody id="attemptTableBody"></tbody>
      </table>
    </div>

    <div style="margin-top:1.2rem;">
      <div class="card-subtitle" style="margin-bottom:0.4rem;">Your answers for the selected quiz</div>
      <div id="answersContainer"></div>
    </div>
  </section>

</div>

<!-- JAVASCRIPT --------------------------------------------- -->

<script>
  const JSON_URL =
    "https://script.google.com/macros/s/AKfycbyF4JX6B4nbu2JzJBzC0hZ5xHJdoQWU9-KiXCYLu84PfZbWi3VfCnLfW15xXQ2Uv3Cw/exec";

  const MAX_KNOW = 3;
  const MAX_UNDER = 18;
  const MAX_EVAL = 8;
  const MAX_TOTAL = 29;

  const QUESTION_LABELS = {
    q1: "Q1",
    q2: "Q2",
    q3: "Q3",
    q4: "Q4",
    q5: "Q5",
    q6: "Q6",
    q7: "Q7"
  };

  function getParam(key) {
    return new URLSearchParams(window.location.search).get(key);
  }

  const pupilNameParam = getParam("name") || "";

  document.getElementById("headerName").textContent =
    `${pupilNameParam} ‚Äì Your Pupil Dashboard`;

  document.getElementById("subtitleText").textContent =
    "Your personalised learning summary";

  document.getElementById("welcomeTitle").textContent =
    `Hello, ${pupilNameParam}. Aim for the higher gifts with joyfulness and kindness.`;

  let allData = [];
  let pupilRows = [];
  let trendChart, topicChart;

  fetch(JSON_URL)
    .then(r => r.json())
    .then(data => {
      allData = data.map(r => ({
        ...r,
        Timestamp: r.Timestamp ? new Date(r.Timestamp) : null,
        s1: Number(r.s1Score || 0),
        s2: Number(r.s2Score || 0),
        s3: Number(r.s3Score || 0),
        total: Number(r.totalScore || 0),
      }));

      initialiseForPupil();
    })
    .catch(() => alert("There was a problem loading your dashboard."));

  function initialiseForPupil() {
    pupilRows = allData.filter(r => (r.studentName || "").trim() === pupilNameParam.trim());
    pupilRows.sort((a,b) => (a.Timestamp || 0) - (b.Timestamp || 0));

    const attempts = pupilRows.length;
    document.getElementById("statAttempts").textContent = attempts;

    if (!attempts) return;

    const avgTotal = avg(pupilRows.map(r => r.total));
    document.getElementById("statAvgTotal").textContent = avgTotal.toFixed(1);

    // Determine strongest and weakest area
    const avgKnow = avg(pupilRows.map(r => r.s1));
    const avgUnder = avg(pupilRows.map(r => r.s2));
    const avgEval = avg(pupilRows.map(r => r.s3));

    const areas = [
      { name: "Knowledge ‚úì", value: avgKnow },
      { name: "Understanding üí°", value: avgUnder },
      { name: "Evaluation and reasoning ‚≠ê", value: avgEval }
    ];

    areas.sort((a,b)=>b.value-a.value);

    document.getElementById("statStrongest").textContent = areas[0].name;
    document.getElementById("statWeakest").textContent = areas[2].name;

    document.getElementById("attemptHint").textContent =
      `You have completed ${attempts} quiz${attempts>1?"zes":""}.`;

    awardBadges(pupilRows);
    generateStrengthSummary();
    renderImprovements();
    renderTrendChart();
    renderTopicChart();
    renderAttemptTable();
    if (pupilRows.length) showAnswers(pupilRows[pupilRows.length-1]);
  }

  /* UTILITIES -------------------------------------------- */

  function avg(arr) {
    if (!arr.length) return 0;
    return arr.reduce((a,b)=>a+b,0) / arr.length;
  }

  function formatDate(d) {
    if (!d) return "";
    return d.toLocaleDateString() + " " +
           d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }

  /* BADGES ------------------------------------------------ */

  function awardBadges(rows) {
    const div = document.getElementById("badgeRow");
    div.innerHTML = "";

    const badges = [];

    // Streak
    let streak = 1;
    for (let i = 1; i < rows.length; i++) {
      if (rows[i].total > rows[i-1].total) streak++;
    }
    if (streak >= 3) badges.push(`üî• Improvement Streak (${streak})`);

    // High Score
    if (rows.some(r => r.total >= 24)) badges.push("üèÜ High Scorer (24+)");

    // Full Marks
    if (rows.some(r => r.total === MAX_TOTAL)) badges.push("üåü Full Marks Moment!");

    // Topic Explorer
    const topics = new Set(rows.map(r => r.quizName));
    if (topics.size >= 3) badges.push("üß≠ Quiz Explorer");

    // Consistency
    const allScores = rows.map(r => r.total);
    const sd = standardDeviation(allScores);
    if (sd < 3) badges.push("üéØ Consistency Champion");

    // AO specialists
    const avgKnow = avg(rows.map(r=>r.s1));
    const avgUnder = avg(rows.map(r=>r.s2));
    const avgEval = avg(rows.map(r=>r.s3));

    const maxAO = Math.max(avgKnow, avgUnder, avgEval);
    if (avgKnow === maxAO) badges.push("üìò Knowledge Master");
    if (avgUnder === maxAO) badges.push("üí° Understanding Pro");
    if (avgEval === maxAO) badges.push("‚≠ê Evaluation & Reasoning Ace");

    badges.forEach(b => {
      const el = document.createElement("span");
      el.className = "badge-pill";
      el.textContent = b;
      div.appendChild(el);
    });
  }

  function standardDeviation(values) {
    if (!values.length) return 0;
    const mean = avg(values);
    const sqDiff = values.map(v => Math.pow(v - mean, 2));
    return Math.sqrt(avg(sqDiff));
  }

  /* STRENGTH SUMMARY ------------------------------------- */

  function generateStrengthSummary() {
    const div = document.getElementById("strengthSummarySentence");
    let strengths = [];

    pupilRows.forEach(r => {
      if (r.ao2Strengths) strengths.push(r.ao2Strengths);
      if (r.ao3Strengths) strengths.push(r.ao3Strengths);
    });

    if (!strengths.length) {
      div.textContent = "";
      return;
    }

    const phrases = [];
    strengths.forEach(t => {
      t.split(/[.;\n]/).forEach(p => {
        const clean = p.trim();
        if (clean) phrases.push(clean);
      });
    });

    const freq = {};
    phrases.forEach(p => freq[p] = (freq[p] || 0) + 1);

    const sorted = Object.entries(freq).sort((a,b)=>b[1]-a[1]);
    const top = sorted.slice(0,3).map(([text]) => text);

    if (top.length === 1)
      div.textContent = `You are doing really well at ${top[0].toLowerCase()}.`;
    else if (top.length === 2)
      div.textContent = `You are doing really well at ${top[0].toLowerCase()} and ${top[1].toLowerCase()}.`;
    else if (top.length === 3)
      div.textContent = `You are doing really well at ${top[0].toLowerCase()}, ${top[1].toLowerCase()} and ${top[2].toLowerCase()}.`;
  }

  /* IMPROVEMENTS ----------------------------------------- */

  function renderImprovements() {
    const chipsDiv = document.getElementById("improvementChips");
    const summaryDiv = document.getElementById("improvementSummarySentence");
    chipsDiv.innerHTML = "";
    summaryDiv.textContent = "";

    const texts = [];
    pupilRows.forEach(r => {
      if (r.ao2Improvements) texts.push(r.ao2Improvements);
      if (r.ao3Improvements) texts.push(r.ao3Improvements);
    });

    if (!texts.length) {
      chipsDiv.innerHTML = `<div class="card-subtitle">Your teacher‚Äôs improvement feedback will appear here.</div>`;
      return;
    }

    const phrases = [];
    texts.forEach(t => {
      t.split(/[.;\n]/).forEach(p => {
        const clean = p.trim();
        if (clean) phrases.push(clean);
      });
    });

    // Summary sentence
    if (phrases.length === 1)
      summaryDiv.textContent = `You are mainly working on ${phrases[0].toLowerCase()}.`;
    else {
      const freq = {};
      phrases.forEach(p => freq[p] = (freq[p] || 0) + 1);
      const sorted = Object.entries(freq).sort((a,b)=>b[1]-a[1]);
      const top = sorted.slice(0,3).map(([text]) => text);

      if (top.length === 1)
        summaryDiv.textContent = `You are mainly working on ${top[0].toLowerCase()}.`;
      else if (top.length === 2)
        summaryDiv.textContent = `You are mainly working on ${top[0].toLowerCase()} and ${top[1].toLowerCase()}.`;
      else if (top.length === 3)
        summaryDiv.textContent = `You are mainly working on ${top[0].toLowerCase()}, ${top[1].toLowerCase()} and ${top[2].toLowerCase()}.`;
    }

    // Chips (top 8)
    const freq = {};
    phrases.forEach(p => freq[p] = (freq[p] || 0) + 1);
    const sorted = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,8);

    sorted.forEach(([phrase]) => {
      const chip = document.createElement("span");
      chip.className = "badge-pill";
      chip.textContent = phrase;
      chip.style.background = "#ffeef0";
      chip.style.border = "1px solid #e5c5c5";
      chip.style.color = "#b71c1c";
      chipsDiv.appendChild(chip);
    });
  }

  /* TABLE -------------------------------------------------- */

  function renderAttemptTable() {
    const tbody = document.getElementById("attemptTableBody");
    tbody.innerHTML = "";

    const rows = pupilRows.slice().reverse();

    rows.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${formatDate(r.Timestamp)}</td>
        <td>${r.quizName || ""}</td>
        <td>${r.total}</td>
        <td>${r.s1}</td>
        <td>${r.s2}</td>
        <td>${r.s3}</td>
      `;
      tr.onclick = () => showAnswers(r);
      tbody.appendChild(tr);
    });
  }

  /* ANSWERS ------------------------------------------------ */

  function showAnswers(row) {
    const div = document.getElementById("answersContainer");
    div.innerHTML = "";

    const header = document.createElement("div");
    header.className = "card-subtitle";
    header.style.marginBottom = "0.7rem";
    header.textContent = `${row.quizName} ¬∑ ${formatDate(row.Timestamp)} ¬∑ Total: ${row.total}`;
    div.appendChild(header);

    ["q1","q2","q3","q4","q5","q6","q7"].forEach(key => {
      if (row[key]) {
        const block = document.createElement("div");
        block.className = "answer-block";
        block.innerHTML = `
          <div class="answer-label">${QUESTION_LABELS[key]}</div>
          <div class="answer-text">${row[key]}</div>
        `;
        div.appendChild(block);
      }
    });

    function fb(label, text) {
      if (!text) return;
      const block = document.createElement("div");
      block.className = "answer-block";
      block.innerHTML = `
        <div class="answer-label">${label}</div>
        <div class="answer-text">${text}</div>
      `;
      div.appendChild(block);
    }

    fb("Understanding ‚Äì strengths", row.ao2Strengths);
    fb("Understanding ‚Äì improvements", row.ao2Improvements);
    fb("Evaluation and reasoning ‚Äì strengths", row.ao3Strengths);
    fb("Evaluation and reasoning ‚Äì improvements", row.ao3Improvements);
  }

  /* CHARTS ------------------------------------------------- */

  function renderTrendChart() {
    const ctx = document.getElementById("trendChart").getContext("2d");

    if (trendChart) trendChart.destroy();

    trendChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: pupilRows.map(r => formatDate(r.Timestamp)),
        datasets: [
          { label: "Total (29)", data: pupilRows.map(r => r.total), borderWidth: 2 },
          { label: "Knowledge (3)", data: pupilRows.map(r => r.s1), borderWidth: 1 },
          { label: "Understanding (18)", data: pupilRows.map(r => r.s2), borderWidth: 1 },
          { label: "Evaluation & reasoning (8)", data: pupilRows.map(r => r.s3), borderWidth: 1 }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, max: MAX_TOTAL }
        }
      }
    });
  }

  function renderTopicChart() {
    const ctx = document.getElementById("topicChart").getContext("2d");

    if (topicChart) topicChart.destroy();

    const groups = {};
    pupilRows.forEach(r => {
      if (!groups[r.quizName]) groups[r.quizName] = [];
      groups[r.quizName].push(r.total);
    });

    const labels = Object.keys(groups);
    const averages = labels.map(q => avg(groups[q]));

    topicChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "Average score (out of 29)",
          data: averages,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true, max: MAX_TOTAL } }
      }
    });
  }

</script>

</body>
</html>
